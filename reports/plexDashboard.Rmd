---
title: "Plex Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
runtime: shiny
---

```{r global, include = FALSE, cache = TRUE}
# Load data in global chunk so it's accessible
library(flexdashboard)
library(tidyverse)
library(httr)
library(httr2)
library(lubridate)
library(treemapify)
library(plotly)
library(shiny)
library(jsonlite)
library(DT)
library(RColorBrewer)
library(dropboxr)

getwd() %>% print()

source(here::here("R", "bootstrap.R"))
source_project("R", "lib", "getLastfm.R")
source_project("R", "lib", "getPlex.R")

getSlugs <- function(text) {
  text %>% 
    as.character() %>%
    stringr::str_to_lower() %>% 
    stringr::str_replace_all(pattern = "&", replacement = " and ") %>%
    stringr::str_remove_all(pattern = "\\([^)]*\\d+[^)]*\\)") %>%
    stringr::str_remove_all(pattern = "\\[[^]]*\\d+[^]]*\\]") %>%
    stringr::str_replace_all(pattern = "\\bvol\\.?\\s+", replacement = "volume ") %>%
    stringr::str_replace_all(pattern = "[[:punct:]]", replacement = " ") %>%
    stringr::str_replace_all(pattern = "\\s{2,}", replacement = " ") %>% 
    stringr::str_trim(side = "both") %>% 
    stringr::str_replace_all(pattern = " ", replacement = "-")
}

apply_year_selection <- function(plex_data, year_choice) {
  if (is.null(year_choice) || year_choice == "All") {
    return(list(chooseYear = 3000, plexYear = plex_data))
  }

  if (stringr::str_detect(year_choice, "^1")) {
    min_year <- as.numeric(year_choice)
    max_year <- min_year + 9
    return(list(
      chooseYear = min_year,
      plexYear = dplyr::filter(plex_data, year >= min_year, year <= max_year)
    ))
  }

  selected_year <- as.numeric(year_choice)
  list(
    chooseYear = year_choice,
    plexYear = dplyr::filter(plex_data, year == selected_year)
  )
}

set_year_state <- function(rv, plex_data, year_choice) {
  year_state <- apply_year_selection(plex_data, year_choice)
  rv$chooseYear <- year_state$chooseYear
  rv$plexYear <- year_state$plexYear
}

artist_choices <- function(plex) {
  plex %>%
    dplyr::filter(!is.na(.data$albumArtist), .data$albumArtist != "Various Artists") %>%
    dplyr::distinct(.data$albumArtist) %>%
        dplyr::mutate(order = str_remove_all("^The ", albumArtist)) %>% 
    dplyr::arrange(.data$order) %>%
    dplyr::pull(.data$albumArtist)
}

complete_album_filter <- function(data) {
  data %>%
    dplyr::group_by(.data$album) %>%
    dplyr::filter(dplyr::n() >= max(.data$trackNum, na.rm = TRUE) - 3) %>%
    dplyr::ungroup()
}

get_discogs_collection <- function(username = "tomcopple") {
  discogs_token <- Sys.getenv("DISCOGS_TOKEN")

  if (!nzchar(discogs_token)) {
    return(tibble::tibble(match = character(), inDiscogs = logical()))
  }

  req <- tryCatch(
    {
      httr2::request(glue::glue("https://api.discogs.com/users/{username}/collection/folders/0/releases?per_page=500")) %>%
        httr2::req_headers(Authorization = glue::glue("Discogs token={discogs_token}"))
    },
    error = function(e) NULL
  )

  if (is.null(req)) {
    return(tibble::tibble(match = character(), inDiscogs = logical()))
  }

  releases <- tryCatch(
    {
      httr2::req_perform(req) %>%
        httr2::resp_body_json() %>%
        purrr::pluck("releases")
    },
    error = function(e) list()
  )

  if (length(releases) == 0) {
    return(tibble::tibble(match = character(), inDiscogs = logical()))
  }

  purrr::map_dfr(releases, function(x) {
    artist <- purrr::pluck(x, "basic_information", "artists", 1, "name", .default = NA_character_)
    album <- purrr::pluck(x, "basic_information", "title", .default = NA_character_)
    tibble::tibble(artist = artist, album = album)
  }) %>%
    dplyr::filter(!is.na(.data$artist), !is.na(.data$album)) %>%
    dplyr::mutate(match = getSlugs(stringr::str_c(.data$artist, .data$album, sep = "-"))) %>%
    dplyr::distinct(.data$artist, .data$album, .data$match) %>%
    dplyr::mutate(inDiscogs = TRUE)
}

load_discogs_overrides <- function(path = NULL) {
  empty_overrides <- tibble::tibble(
    plexArtist = character(),
    plexAlbum = character(),
    discogsArtist = character(),
    discogsAlbum = character(),
    notes = character(),
    plexMatch = character(),
    discogsMatch = character()
  )

  tsv_path <- here::here("data", "raw", "discogs_overrides.tsv")
  csv_path <- here::here("data", "raw", "discogs_overrides.csv")

  if (is.null(path)) {
    path <- dplyr::case_when(
      file.exists(tsv_path) ~ tsv_path,
      file.exists(csv_path) ~ csv_path,
      TRUE ~ tsv_path
    )
  }

  if (!file.exists(path)) {
    return(empty_overrides)
  }

  overrides_raw <- tryCatch(
    {
      if (stringr::str_detect(path, "\\.tsv$")) {
        readr::read_tsv(path, show_col_types = FALSE)
      } else {
        readr::read_csv(path, show_col_types = FALSE)
      }
    },
    error = function(e) {
      warning(paste0("Could not parse overrides file '", path, "': ", e$message))
      empty_overrides
    }
  )

  overrides_raw %>%
    dplyr::mutate(dplyr::across(dplyr::everything(), as.character)) %>%
    dplyr::filter(
      !is.na(.data$plexArtist), .data$plexArtist != "",
      !is.na(.data$plexAlbum), .data$plexAlbum != "",
      !is.na(.data$discogsArtist), .data$discogsArtist != "",
      !is.na(.data$discogsAlbum), .data$discogsAlbum != ""
    ) %>%
    dplyr::mutate(
      plexMatch = getSlugs(stringr::str_c(.data$plexArtist, .data$plexAlbum, sep = "-")),
      discogsMatch = getSlugs(stringr::str_c(.data$discogsArtist, .data$discogsAlbum, sep = "-"))
    ) %>%
    dplyr::distinct(.data$plexMatch, .keep_all = TRUE)
}

build_all_albums_data <- function(plex_data, lastfm_data, discogs_data, overrides_data = NULL) {
  if (is.null(overrides_data)) {
    overrides_data <- tibble::tibble(plexMatch = character(), discogsMatch = character(), notes = character())
  }

  plex_summary <- plex_data %>%
    dplyr::filter(.data$albumArtist != "Various Artists") %>%
    complete_album_filter() %>%
    dplyr::group_by(.data$albumArtist, .data$album) %>%
    dplyr::summarise(
      ratedTracks = sum(!is.na(.data$rating)),
      totalTracks = dplyr::n(),
      avRat = round(mean(.data$rating, na.rm = TRUE) / 2, 2),
      .groups = "drop"
    ) %>%
    dplyr::mutate(avRat = dplyr::if_else(is.nan(.data$avRat), NA_real_, .data$avRat))

  lastfm_summary <- lastfm_data %>%
    dplyr::group_by(.data$artist, .data$album) %>%
    dplyr::summarise(Plays = dplyr::n(), .groups = "drop") %>%
    dplyr::rename(albumArtist = .data$artist)

  plex_summary %>%
    dplyr::mutate(plexMatch = getSlugs(stringr::str_c(.data$albumArtist, .data$album, sep = "-"))) %>%
    dplyr::left_join(
      overrides_data %>% dplyr::select(.data$plexMatch, .data$discogsMatch) %>% dplyr::distinct(),
      by = "plexMatch"
    ) %>%
    dplyr::mutate(
      match = dplyr::coalesce(.data$discogsMatch, .data$plexMatch),
      overrideApplied = !is.na(.data$discogsMatch)
    ) %>%
    dplyr::left_join(
      lastfm_summary %>%
        dplyr::mutate(plexMatch = getSlugs(stringr::str_c(.data$albumArtist, .data$album, sep = "-"))) %>%
        dplyr::select(.data$plexMatch, .data$Plays),
      by = "plexMatch"
    ) %>%
    dplyr::left_join(
      discogs_data %>% dplyr::select(.data$match, .data$inDiscogs) %>% dplyr::distinct(),
      by = "match"
    ) %>%
    dplyr::mutate(
      Plays = tidyr::replace_na(.data$Plays, 0),
      inDiscogs = tidyr::replace_na(.data$inDiscogs, FALSE),
      n = stringr::str_c(.data$ratedTracks, .data$totalTracks, sep = "/")
    ) %>%
    dplyr::select(.data$albumArtist, .data$album, .data$n, .data$avRat, .data$Plays, .data$inDiscogs, .data$overrideApplied) %>%
    dplyr::arrange(dplyr::desc(.data$avRat), dplyr::desc(.data$Plays))
}

build_discogs_debug_data <- function(plex_data, discogs_data, overrides_data = NULL) {
  if (is.null(overrides_data)) {
    overrides_data <- tibble::tibble(plexMatch = character(), discogsMatch = character(), notes = character())
  }

  if (!all(c("artist", "album", "match") %in% names(discogs_data))) {
    return(tibble::tibble(
      albumArtist = character(),
      album = character(),
      plexSlug = character(),
      discogsCandidates = character(),
      discogsCandidateSlugs = character(),
      candidateCount = integer()
    ))
  }

  plex_albums <- plex_data %>%
    dplyr::filter(.data$albumArtist != "Various Artists") %>%
    complete_album_filter() %>%
    dplyr::group_by(.data$albumArtist, .data$album) %>%
    dplyr::summarise(totalTracks = dplyr::n(), .groups = "drop") %>%
    dplyr::mutate(
      match = getSlugs(stringr::str_c(.data$albumArtist, .data$album, sep = "-")),
      artistSlug = getSlugs(.data$albumArtist)
    )

  discogs_albums <- discogs_data %>%
    dplyr::distinct(.data$artist, .data$album, .data$match) %>%
    dplyr::mutate(
      artistSlug = getSlugs(.data$artist),
      candidate = stringr::str_c(.data$artist, " - ", .data$album),
      candidateSlug = .data$match
    )

  unmatched_plex <- plex_albums %>%
    dplyr::anti_join(discogs_albums %>% dplyr::distinct(.data$match), by = "match")

  if (nrow(overrides_data) > 0) {
    unmatched_plex <- unmatched_plex %>%
      dplyr::anti_join(overrides_data %>% dplyr::select(.data$plexMatch) %>% dplyr::distinct(),
                       by = c("match" = "plexMatch"))
  }

  unmatched_plex %>%
    dplyr::left_join(
      discogs_albums %>%
        dplyr::select(.data$artistSlug, .data$candidate, .data$candidateSlug) %>%
        dplyr::distinct(),
      by = "artistSlug"
    ) %>%
    dplyr::filter(!is.na(.data$candidate)) %>%
    dplyr::group_by(.data$albumArtist, .data$album, plexSlug = .data$match) %>%
    dplyr::summarise(
      candidateCount = dplyr::n_distinct(.data$candidate),
      discogsCandidates = stringr::str_c(head(sort(unique(.data$candidate)), 5), collapse = " | "),
      discogsCandidateSlugs = stringr::str_c(head(sort(unique(.data$candidateSlug)), 5), collapse = " | "),
      .groups = "drop"
    ) %>%
    dplyr::arrange(dplyr::desc(.data$candidateCount), .data$albumArtist, .data$album)
}

# Use functions -----
removeEve <- function(lastfm) {
  lastfm <- lastfm %>% 
    filter(
      stringr::str_detect(artist, "Cocomelon", negate = TRUE),
      stringr::str_detect(artist, "Super Simple", negate = TRUE),
      stringr::str_detect(artist, "Duggee", negate = TRUE),
      stringr::str_detect(artist, "Lullaby", negate = TRUE),
      stringr::str_detect(artist, "Night Garden", negate = TRUE),
      stringr::str_detect(track, "Night Garden", negate = TRUE),
      stringr::str_detect(artist, "Toddler Tunes", negate = TRUE),
      stringr::str_detect(artist, "Pinkfong", negate = TRUE),
      stringr::str_detect(artist, "Idina Menzel", negate = TRUE),
      stringr::str_detect(artist, "Stephanie Beatriz", negate = TRUE),
      stringr::str_detect(artist, "Dwayne Johnson", negate = TRUE),
      stringr::str_detect(artist, "Bluey", negate = TRUE),
      stringr::str_detect(track, "Hey Gabby", negate = TRUE)
    )
}

plex <- getPlex(F)
lastfm <- getLastfm(F) %>% removeEve()
discogs <- get_discogs_collection()
discogs_overrides <- load_discogs_overrides()


```

```{r}
rv <- reactiveValues(plex = plex,
                     lastfm = lastfm,
                     discogs = discogs,
                     discogsOverrides = discogs_overrides,
                     chooseYear = 3000,
                     plexYear = plex)

allAlbumsCombined <- reactive({
  build_all_albums_data(rv$plex, rv$lastfm, rv$discogs, rv$discogsOverrides)
})

discogsDebugCombined <- reactive({
  build_discogs_debug_data(rv$plex, rv$discogs, rv$discogsOverrides)
})

observeEvent(eventExpr = input$refreshPlex,
             handlerExpr = {
               showNotification("Updating Plex...")
               rv$plex <- getPlex(T)
               set_year_state(rv, rv$plex, input$chooseYear)
               shiny::updateSelectizeInput(
                 session,
                 inputId = "compareArtist",
                 choices = artist_choices(rv$plex),
                 selected = input$compareArtist,
                 server = TRUE
               )
               showNotification("Plex Updated!", type = 'message')
             })

observeEvent(eventExpr = input$refreshLastfm,
             handlerExpr = {
               showNotification("Updating Lastfm")
               rv$lastfm <- getLastfm(T) %>% removeEve()
               showNotification("Lastfm Updated!", type = 'message')
             })

observeEvent(eventExpr = input$reloadDiscogsOverrides,
             handlerExpr = {
               rv$discogsOverrides <- load_discogs_overrides()
               showNotification(
                 paste0("Discogs overrides reloaded (", nrow(rv$discogsOverrides), " rows)."),
                 type = 'message'
               )
             })

observeEvent(eventExpr = input$chooseYear,
             handlerExpr = {
               set_year_state(rv, rv$plex, input$chooseYear)
             })
```

# Artist Comparison

## Artists Sidebar {.sidebar data-width="300"}

```{r}
shiny::radioButtons(
  inputId = "compareArtist",
  label = "Select artist",
  choices = artist_choices(plex),
  # options = list(placeholder = "Choose an artist"),
  selected = artist_choices(plex) %>% sample(1)
)
```

## Row {data-height="90"}

### 

```{r, out.width = "100%", fig.height = 0.5, eval = T}
renderPlot({
  progress <-  rv$plex %>%
      filter(albumArtist == input$compareArtist) %>%
      # filter(albumArtist == 'Damien Jurado') %>% 
    summarise(n1 = n(), n2 = sum(!is.na(rating))) %>% 
    transmute(perc = n2/n1, tot = 1-perc) %>% 
    gather() %>% rowwise() %>%  
    mutate(label = ifelse(test = key == 'perc', 
                          yes = str_c(round(100*value, 0), "%"), no = "")) %>% 
    ggplot(aes(x = 1, y = value, fill = rev(key), alpha = rev(key))) + 
    geom_col(position = 'fill', color = "#003EBB") + 
    coord_flip() + 
    scale_fill_manual(values = (c("#C1D1F4", "#003EBB"))) + 
    scale_alpha_manual(values = c(0.5, 1)) + 
    geom_label(aes(label = label, y = 0.9), size = 3, fill = 'white', linewidth = 0, fontface = 2)  + 
    theme_void()+ 
    theme(legend.position = 'none', 
          plot.background = element_rect(fill = 'white', color = 'white'),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank()) +
      ggtitle(input$compareArtist)
  # ggplotly(progress) %>% layout(height=80)
  progress
})

```

## Row {data-height=1200}

### Artist Albums

```{r}
DT::renderDataTable({
  req(input$compareArtist)

  artistAlbums <- rv$plex %>%
      # filter(albumArtist == 'The Flaming Lips') %>% 
    filter(albumArtist == input$compareArtist) %>%
    complete_album_filter() %>%
    group_by(album) %>%
    summarise(
      rated = sum(!is.na(rating)),
      total = n(),
      avRat = round(mean(rating, na.rm = TRUE) / 2, 2),
      year = suppressWarnings(max(year, na.rm = TRUE)),
      .groups = 'drop'
    ) %>%
    mutate(
      year = ifelse(is.infinite(year), NA, year),
      avRat = ifelse(is.nan(avRat), NA, avRat)
    ) %>%
    left_join(
      # rv$lastfm %>%filter(artist == input$compareArtist) %>%
          lastfm %>% filter(artist == 'The Flaming Lips') %>% 
        count(album, name = "Plays"),
      by = "album"
    ) %>%
    mutate(Plays = replace_na(Plays, 0)) %>%
    unite(col = 'n', rated, total, sep = "/") %>%
    arrange(desc(avRat), desc(Plays))

  # if (input$compareCompleteArtist) {
  #   artistAlbums <- artistAlbums %>%
  #     separate(col = 'n', into = c('rated', 'total'), sep = "/", remove = FALSE) %>%
  #     filter(rated == total) %>%
  #     select(-rated, -total)
  # }

  DT::datatable(artistAlbums, options = list(pageLength = 20))
})
```

## Row

### Ratings (circles)

```{r, eval = T}
renderPlot({
  req(input$compareArtist)
 
  plotData <- rv$plex %>%
      filter(albumArtist == input$compareArtist) %>% 
      select(albumArtist, album, track, trackNum, rating) %>% 
    complete_album_filter() %>%
    mutate(album = ifelse(nchar(album) > 24,
                          str_c(str_sub(album, 0, 22), "..."),
                          album)) %>%
    mutate(rating0 = replace_na(rating, 0)) %>%
    group_by(album) %>% 
    mutate(avRat = mean(rating, na.rm = T), count = n()) %>% 
      filter(count > 2) %>%  
    mutate(rating = rating0/2, avRat = avRat/2) %>% 
    mutate(title = album) %>% 
    arrange(title) %>% 
    mutate(title = forcats::fct_rev(title))

  if (nrow(plotData) == 0) {
    ggplot() +
      theme_void() +
      annotate("text", x = 0, y = 0, label = "No albums found for current artist")
  } else {
    plotData %>%
      ggplot(aes(x = trackNum, y = title, fill = rating)) +
      geom_point(shape = 21, size = 6) +
          scale_fill_gradient("",
                low = "#FFFFFF",   
                high = "#3c50b1",  
                limits = c(0, 5),  
                breaks = 0:5) +
      xlab(NULL) + ylab(NULL)
  }

})

```


### Ratings (lines)

```{r}
renderPlotly({
  req(input$compareArtist)
    
   plotData <- rv$plex %>%
    filter(albumArtist == input$compareArtist) %>%
    complete_album_filter() %>%
      filter(!is.na(rating)) %>% 
      distinct(album, track, rating, trackNum) %>%
      mutate(trackNum = suppressWarnings(as.numeric(trackNum))) %>%
      filter(!is.na(trackNum))
   
   numberOfAlbums <- length(unique(plotData$album))
   
   smoothPoints <- plotData %>% 
       group_by(album) %>% 
       arrange(trackNum, .by_group = TRUE) %>% 
       mutate(
         n = dplyr::n(),
         avRat = mean(rating),
         smooth = if (n() >= 4 && n_distinct(trackNum) >= 4) {
             fit <- loess(rating ~ trackNum, data = cur_data(), 
                          span = 0.75, degree = 2)
             predict(fit, newdata = cur_data()["trackNum"])
             } else {
                 avRat
                 }
       ) %>% 
       ungroup()
      
   plot_ly() %>% 
      plotly::add_lines(
          data = smoothPoints, showlegend = FALSE,
          x = ~trackNum, y = ~smooth/2, line = list(shape = "spline", smoothing = 2.2),
          color = ~album, 
          colors = colorRampPalette(brewer.pal(11, 'Spectral'))(numberOfAlbums)
      ) %>% 
       plotly::add_markers(
           data = plotData, 
           x = ~trackNum, y = ~rating/2, showlegend = FALSE,
           legendgroup = ~album, color = ~album,
           text = ~str_glue("{track} ({rating})<br>{album}"),
           opacity = 0.5, hoverinfo = 'text') %>% 
       plotly::layout(
           xaxis = list(title = NA, zeroline = FALSE),
           yaxis = list(title = NA, zeroline = FALSE)
       )
})
```

# Year comparison

## Sidebar {.sidebar data-width="250"}

```{r}
shiny::radioButtons(inputId = "chooseYear", label = "Select year:",
            choiceValues = c("All", '1950', '1960', '1970', '1980', '1990', 
    ## This used to be plex %>% na.omit %>% pull(year), can't remember why.
    c(2000:max(plex %>% filter(!is.na(year)) %>% pull(year)))), 
            choiceNames = c("All time", 
                            plex %>%
              filter(year >= 1950, albumArtist != 'Various Artists') %>% 
              mutate(choiceLabel = ifelse(
                year > 1999, year, 10*floor(year/10)
              )) %>% 
              distinct(albumArtist, album, choiceLabel) %>% 
              count(choiceLabel) %>% 
              arrange(choiceLabel) %>% 
              mutate(n = str_c("(", n, ")")) %>% 
              unite(choiceLabel, n, col = 'choiceLabel', sep = " ") %>% 
              pull(choiceLabel)),
              selected = max(plex$year, na.rm = TRUE)
)

actionButton(inputId = "refreshPlex", label = "Refresh Plex", icon = icon('refresh'))

actionButton(inputId = "refreshLastfm", label = "Refresh Lastfm", icon = icon("refresh"))
```

## Row 1 {data-height="50"}

### Rating Progress

```{r, out.width = "100%", fig.height = 0.5, eval = T}
renderPlot({
  progress <-  rv$plexYear %>% 
    summarise(n1 = n(), n2 = sum(!is.na(rating))) %>% 
    transmute(perc = n2/n1, tot = 1-perc) %>% 
    gather() %>% rowwise() %>%  
    mutate(label = ifelse(test = key == 'perc', 
                          yes = str_c(round(100*value, 0), "%"), no = "")) %>% 
    ggplot(aes(x = 1, y = value, fill = rev(key), alpha = rev(key))) + 
    geom_col(position = 'fill', color = "#003EBB") + 
    coord_flip() + 
    scale_fill_manual(values = (c("#C1D1F4", "#003EBB"))) + 
    scale_alpha_manual(values = c(0.5, 1)) + 
    geom_label(aes(label = label, y = 0.9), size = 3, fill = 'white', label.size = 0, fontface = 2)  + 
    theme_void()+ 
    theme(legend.position = 'none', 
          plot.background = element_rect(fill = 'white', color = 'white'),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank())
  # ggplotly(progress) %>% layout(height=80)
  progress
})

```

## Row table

### All albums

```{r}
shiny::checkboxInput(inputId = "onlyComplete", label = "Only include complete ratings", value = FALSE)
```

```{r, eval = T, out.width ="100%"}
DT::renderDataTable({
  data <- rv$plexYear %>% 
    filter(albumArtist != 'Various Artists') %>% 
    complete_album_filter() %>%
    group_by(albumArtist, album) %>% 
    summarise(x = n(), y = sum(!is.na(rating)),
              avRat = round(mean(rating, na.rm = TRUE) / 2, 2),
              .groups = 'drop') %>% 
    filter(x > 2) %>% 
    unite(col = 'match', albumArtist, album, sep = "-", remove = FALSE) %>% 
    mutate(match = getSlugs(match)) %>% 
    left_join(., 
              # rv$lastfm %>% 
              rv$lastfm %>% 
                unite(col = 'match', artist, album, sep = "-", remove = TRUE) %>% 
                mutate(match = getSlugs(match)) %>% 
                count(match, sort = T, name = 'Plays'),
              by = 'match') %>% 
    select(-match) %>% 
    arrange(desc(avRat)) %>% 
    unite(y, x, col = 'n', sep = "/")
    
  if (input$onlyComplete) {
    data <- data %>% 
      separate(col = 'n', sep = "/", into = c('x', 'y'), remove = FALSE) %>% 
      filter(x == y) %>% 
      select(-x, -y)
  }
  DT::datatable(data, options = list(
    bPaginate = TRUE
  ))
})

```

## Row table

### Top Songs

```{r, eval = T, out.width ="100%"}
DT::renderDataTable({
  data <- rv$plexYear %>% 
      select(artist, track, rating) %>% 
      filter(rating > 6) %>% 
    unite(col = 'match', artist, track, sep = "-", remove = FALSE) %>% 
    mutate(match = getSlugs(match)) %>% 
    left_join(., 
              # rv$lastfm %>%
              rv$lastfm %>%
                unite(col = 'match', artist, track, sep = "-", remove = TRUE) %>% 
                mutate(match = getSlugs(match)) %>% 
                count(match, sort = T, name = 'Plays'),
              by = 'match') %>% 
    select(-match) %>% 
    arrange(desc(rating), desc(Plays)) 
    
    DT::datatable(data, options = list(
        bPaginate = TRUE
        ))
})

```

## Row {data-height="50"}

### 

```{r}
shiny::checkboxInput(inputId = "onlyPlex", label = "Only include Plex", value = FALSE)
```

## Row

### Top Album Plays (Plex in blue)

```{r, eval = T}
renderPlot({
  
  if (rv$chooseYear == 3000) {
    ## Copy pretty much same as below, with entire lastfm history and entire plex library
    print ("All time")
    albums <- full_join(
      rv$lastfm %>%
        unite(col = 'match', artist, album, sep = "-", remove = FALSE) %>% 
        mutate(match = getSlugs(match)) %>% 
        count(artist, album, match, sort = T),
      rv$plex %>% 
        unite(col = 'match', albumArtist, album, sep = "-", remove = TRUE) %>% 
        mutate(match = getSlugs(match), inPlex = 1) %>%
        distinct(match, inPlex),
      by = 'match'
    ) %>% 
      arrange(desc(n)) %>% 
      mutate(inPlex = replace_na(inPlex, 0)) %>% 
      mutate(inPlex = as.factor(inPlex),
             rank = row_number())
  } else if(rv$chooseYear >= 2006) {
    print("2006")
    # From 2006 onwards, take 25 most played albums from lastfm, see if they're in plex
    inPlex <- rv$plex %>% 
      unite(col = 'match', albumArtist, album, sep = " - ", remove = TRUE) %>% 
      mutate(match = getSlugs(match), inPlex = 1) %>% 
      distinct(match, inPlex)
    lastfmCount <- rv$lastfm %>% 
      filter(year(date) == as.numeric(input$chooseYear)) %>%
      unite(col = 'match', artist, album, sep = " - ", remove = FALSE) %>% 
      mutate(match = getSlugs(match)) %>% 
      count(artist, album, match, sort = T) 
    albums <- left_join(
      lastfmCount,
      inPlex,
      by = 'match'
    ) %>% 
      arrange(desc(n)) %>% 
      mutate(inPlex = replace_na(inPlex, 0)) %>% 
      mutate(inPlex = forcats::as_factor(inPlex),
             rank = row_number())
    
    } else {
      # Before 2006 just take plex albums from that year and arrange by playcount
      plexCount <- rv$plexYear %>% 
        unite(col = 'match', albumArtist, album, sep = " - ", remove = FALSE) %>% 
        mutate(match = getSlugs(match), inPlex = 1) %>% 
        distinct(artist = albumArtist, album, match, inPlex)
    lastfmCount <- rv$lastfm %>% 
      unite(col = 'match', artist, album, sep = " - ", remove = TRUE) %>% 
      mutate(match = getSlugs(match)) %>% 
      count(match, sort = T)
    albums <- left_join(
      plexCount,
      lastfmCount,
      by = 'match'
    ) %>% 
      arrange(desc(n)) %>% 
      mutate(inPlex = replace_na(inPlex, 0)) %>% 
      mutate(inPlex = forcats::as_factor(inPlex),
             rank = row_number())
        
    }
    
    albums %>% 
      purrr::when(
        input$onlyPlex ~ filter(., inPlex == 1),
        ~ .
      ) %>% 
      slice(1:25) %>% 
      unite(col = 'name', artist, album, sep = " - ") %>% 
      mutate(nchar = nchar(name)) %>% 
      mutate(name = ifelse(nchar > 47, str_c(str_sub(name, 0, 47), "..."), name)) %>% 
      mutate(name = forcats::fct_rev(forcats::fct_inorder(name))) %>% 
      ggplot(aes(x = name, y = n, fill = inPlex, group = inPlex)) + 
      geom_col(width = 0.7, color = "#003EBB") + 
      scale_fill_manual(values = c('white', "#809FDD"),
                        breaks = c(0, 1)) +
      theme(legend.position = 'none') +
      xlab(NULL) + ylab(NULL) +
      coord_flip()
})
```

### Track Plays (Plex in blue)

```{r, eval = T}
renderPlot({
  
  if (rv$chooseYear == 3000) {
    ## Copy pretty much same as below, with entire lastfm history and entire plex library
    print ("All time")
    tracks <- full_join(
      rv$lastfm %>%
        unite(col = 'match', artist, track, sep = "-", remove = FALSE) %>% 
        mutate(match = getSlugs(match)) %>% 
        count(artist, track, match, sort = T),
      rv$plex %>% 
        unite(col = 'match', artist, track, sep = "-", remove = TRUE) %>% 
        mutate(match = getSlugs(match), inPlex = 1) %>%
        distinct(match, inPlex),
      by = 'match'
    ) %>% 
      arrange(desc(n)) %>% 
      mutate(inPlex = replace_na(inPlex, 0)) %>% 
      mutate(inPlex = as.factor(inPlex),
             rank = row_number())
  } else if(rv$chooseYear >= 2006) {
    print("2006")
    # From 2006 onwards, take 25 most played tracks from lastfm, see if they're in plex
    inPlex <- rv$plex %>% 
      unite(col = 'match', artist, track, sep = " - ", remove = TRUE) %>% 
      mutate(match = getSlugs(match), inPlex = 1) %>% 
      distinct(match, inPlex)
    lastfmCount <- rv$lastfm %>% 
      filter(year(date) == as.numeric(input$chooseYear)) %>%
      unite(col = 'match', artist, track, sep = " - ", remove = FALSE) %>% 
      mutate(match = getSlugs(match)) %>% 
      count(artist, track, match, sort = T)
    tracks <- left_join(
      lastfmCount,
      inPlex,
      by = 'match'
    ) %>% 
      arrange(desc(n)) %>% 
      mutate(inPlex = replace_na(inPlex, 0)) %>% 
      mutate(inPlex = forcats::as_factor(inPlex),
             rank = row_number())
    
    } else {
      # Before 2006 just take plex albums from that year and arrange by playcount
      plexCount <- rv$plexYear %>% 
        unite(col = 'match', artist, track, sep = " - ", remove = FALSE) %>% 
        mutate(match = getSlugs(match), inPlex = 1) %>% 
        distinct(artist, track, match, inPlex)
    lastfmCount <- rv$lastfm %>% 
      unite(col = 'match', artist, track, sep = " - ", remove = TRUE) %>% 
      mutate(match = getSlugs(match)) %>% 
      count(match, sort = T)
    tracks <- left_join(
      plexCount,
      lastfmCount,
      by = 'match'
    ) %>% 
      arrange(desc(n)) %>% 
      mutate(inPlex = replace_na(inPlex, 0)) %>% 
      mutate(inPlex = forcats::as_factor(inPlex),
             rank = row_number())
        
    }
    
    tracks %>% 
      purrr::when(
        input$onlyPlex ~ filter(., inPlex == 1),
        ~ .
      ) %>% 
      slice(1:25) %>% 
      unite(col = 'name', artist, track, sep = " - ") %>% 
      mutate(nchar = nchar(name)) %>% 
      mutate(name = ifelse(nchar > 47, str_c(str_sub(name, 0, 47), "..."), name)) %>% 
      mutate(name = forcats::fct_rev(forcats::fct_inorder(name))) %>% 
      ggplot(aes(x = name, y = n, fill = inPlex, group = inPlex)) + 
      geom_col(width = 0.7, color = "#003EBB") + 
      scale_fill_manual(values = c('white', "#809FDD"),
                        breaks = c(0, 1)) +
      theme(legend.position = 'none') +
      xlab(NULL) + ylab(NULL) +
      coord_flip()
})
```

## Row

### Ratings 1

```{r, eval = T}
renderPlot({
  req(rv$plexYear)
 
  plotData <- rv$plexYear %>%
      select(albumArtist, album, track, trackNum, rating) %>% 
    # filter(albumArtist != 'Various Artists') %>% 
    complete_album_filter() %>%
    mutate(album = ifelse(nchar(album) > 24,
                          str_c(str_sub(album, 0, 22), "..."),
                          album)) %>%
    mutate(rating0 = replace_na(rating, 0)) %>%
    group_by(albumArtist, album) %>% 
    mutate(avRat = mean(rating, na.rm = T), count = n()) %>% 
      filter(count > 2) %>% 
    group_by(albumArtist, album, avRat) %>% 
    nest() %>%
    ungroup() %>%
    arrange(desc(avRat)) %>% 
    slice(1:50) %>% 
    unnest(cols = c(data)) %>% 
    mutate(rating = rating0/2, avRat = avRat/2) %>% 
    mutate(title = album) %>% 
    arrange(title) %>% 
    mutate(title = forcats::fct_rev(title))

  if (nrow(plotData) == 0) {
    ggplot() +
      theme_void() +
      annotate("text", x = 0, y = 0, label = "No albums found for current year filter")
  } else {
    plotData %>%
      ggplot(aes(x = trackNum, y = title, fill = rating)) +
      geom_point(shape = 21, size = 6) +
          scale_fill_gradient("",
                low = "#FFFFFF",   # Your vibrant light blue
                high = "#3c50b1",  # Your deep midnight blue
                limits = c(0, 5),  # Ensures the scale is always 0 to 5
                breaks = 0:5) +
      xlab(NULL) + ylab(NULL)
  }

})

```

### Ratings 2

```{r}
## Trying a new plot
renderPlot({
  colPal <- c('#FFFFFF', colorRampPalette(c("#B9E2FF", "#3c50b1"))(10))
  names(colPal) <- seq(from = 0, to = 5, by = 0.5)
  
  treemapData <- rv$plexYear %>% 
      select(album, rating, track) %>% 
      mutate(rating = replace_na(rating, 0),
             rating = round(rating / 2),
             n = 1) %>% 
      mutate(rating = forcats::as_factor(rating))
  
  treemap <- ggplot(treemapData, aes(area = n, fill = rating, 
                                     subgroup = album, subgroup2 = track)) +
      treemapify::geom_treemap() +
      treemapify::geom_treemap_subgroup_border(size = 5) +
      treemapify::geom_treemap_subgroup2_border(size = 0.5, color = 'light grey') +
      treemapify::geom_treemap_subgroup_text(place = 'center', alpha = 0.5, grow = T) +
      scale_fill_manual(values = colPal, 
                            breaks = c("0", "1", "2", "3", "4", "5"))
  treemap

    
})
```

# All albums

## Album Sidebar {.sidebar data-width="300"}

```{r}
shiny::radioButtons(
  inputId = "allAlbumsView",
  label = "View",
  choices = c("Chart" = "chart", "Data table" = "table"),
  selected = "chart",
  inline = TRUE
)

shiny::conditionalPanel(
  condition = "input.allAlbumsView == 'chart'",
  shiny::checkboxInput(inputId = "complete2", label = "Only complete ratings", value = FALSE),
  shiny::textInput(inputId = 'filterText', label = 'Search', value = '', width = "100%")
)

shiny::conditionalPanel(
  condition = "input.allAlbumsView == 'table'",
  shiny::numericInput(inputId = "minPlays", label = "Minimum Last.fm plays", value = 0, min = 0, step = 1),
  shiny::sliderInput(inputId = "ratingRange", label = "Average Plex rating", min = 0, max = 5, value = c(0, 5), step = 0.1),
  shiny::selectInput(
    inputId = "discogsFilter",
    label = "Discogs collection",
    choices = c("All albums" = "all", "In collection" = "in", "Not in collection" = "out"),
    selected = "all"
  )
)
```

## Row 

```{r}
output$allAlbumsMain <- shiny::renderUI({
  chart_height_px <- 1200

  if (input$allAlbumsView == "chart") {
    searchText <- if (is.null(input$filterText)) "" else input$filterText
    searchPattern <- getSlugs(searchText)

    filteredData <- rv$plex %>%
      unite(albumArtist, album, col = 'filterText', sep = " ", remove = FALSE) %>%
      mutate(filterText = getSlugs(filterText))

    if (nzchar(searchPattern)) {
      filteredData <- filteredData %>%
        filter(str_detect(string = filterText, pattern = searchPattern))
    }

    albumData <- filteredData %>%
      select(-filterText) %>%
      complete_album_filter() %>%
      ungroup()

    if (isTRUE(input$complete2)) {
      albumData <- albumData %>%
        group_by(albumArtist, album) %>%
        filter(all(!is.na(rating)), n() >= 3) %>%
        ungroup()
    }

    album_count <- albumData %>%
      mutate(rating = ifelse(rating == 0, NA, rating)) %>%
      group_by(album) %>%
      mutate(count = n()) %>%
      filter(count > 2) %>%
      na.omit() %>%
      ungroup() %>%
      summarise(n = dplyr::n_distinct(album)) %>%
      dplyr::pull(n) %>%
      dplyr::first()

    if (is.na(album_count) || album_count < 1) {
      album_count <- 1
    }

    chart_height_px <- min(18000, max(800, album_count * 18))
  }

  if (input$allAlbumsView == "chart") {
    plotly::plotlyOutput("allAlbumsChart", width = "100%")
  } else {
    shiny::tags$div(
      style = "height: 82vh; overflow-y: auto;",
      DT::DTOutput("allAlbumsTable")
    )
  }
})

shiny::uiOutput("allAlbumsMain")
```

```{r}
output$allAlbumsChart <- renderPlotly({
  colors <- c('#FFFFFF', '#6475C4', '#3B50B2')
  plot_width_px <- session$clientData$output_allAlbumsChart_width

  if (is.null(plot_width_px) || !is.finite(plot_width_px) || plot_width_px < 300) {
    plot_width_px <- 1050
  }

  searchText <- if (is.null(input$filterText)) "" else input$filterText
  searchPattern <- getSlugs(searchText)

  filteredData <- rv$plex %>%
    unite(albumArtist, album, col = 'filterText', sep = " ", remove = FALSE) %>%
    mutate(filterText = getSlugs(filterText))

  if (nzchar(searchPattern)) {
    filteredData <- filteredData %>%
      filter(str_detect(string = filterText, pattern = searchPattern))
  }

  albumData <- filteredData %>%
    select(-filterText) %>%
    complete_album_filter() %>%
    ungroup()

  if (isTRUE(input$complete2)) {
    albumData <- albumData %>%
      group_by(albumArtist, album) %>%
      filter(all(!is.na(rating)), n() > 3) %>%
      ungroup()
  }

  plotData <- albumData %>%
    mutate(rating = ifelse(rating == 0, NA, rating)) %>%
    group_by(album) %>%
    mutate(y = n(), count = n()) %>%
    filter(count > 2) %>%
    na.omit() %>%
    mutate(x = n()) %>%
    group_by(albumArtist, album, x, y) %>% summarise(avRat = mean(rating) / 2, .groups = 'drop') %>%
    arrange(avRat) %>%
    mutate(album = str_c(album, " (", round(avRat, 2), ")")) %>%
    mutate(album = ifelse(nchar(album) > 60, str_c(str_sub(album, 1, 60), "..."), album)) %>%
    mutate(album = forcats::fct_inorder(album)) %>%
    mutate(compRat = (x / y) * avRat) %>%
    select(-x, -y) %>%
    gather(-album, -albumArtist, key = series, value = Rating)

  if (nrow(plotData) == 0) {
    return(
      plotly::plot_ly() %>%
        layout(
          title = "No albums found for current filter",
          xaxis = list(visible = FALSE),
          yaxis = list(visible = FALSE)
        )
    )
  }

  album_count <- plotData %>%
    filter(series == 'avRat') %>%
    summarise(n = dplyr::n_distinct(album)) %>%
    pull(n)

  if (is.na(album_count) || album_count < 1) {
    album_count <- 1
  }

  y_tick_size <- dplyr::case_when(
    album_count > 600 ~ 8,
    album_count > 250 ~ 9,
    album_count > 100 ~ 10,
    TRUE ~ 12
  )

  chart_height_px <- min(18000, max(800, album_count * 18))

  margin_left <- 160

  plotly::plot_ly(
    plotData %>% filter(series == 'avRat'),
    x = ~Rating, y = ~album, type = 'bar', orientation = 'h',
    text = ~str_c(albumArtist, ": ", album), hoverinfo = 'text',
    marker = list(color = colors[1], line = list(color = colors[2], width = 0.2))
  ) %>%
    add_trace(
      data = plotData %>% filter(series == 'compRat'),
      marker = list(color = colors[2]), hoverinfo = 'none'
    ) %>%
    layout(
      autosize = TRUE,
      width = plot_width_px,
      height = chart_height_px,
      xaxis = list(title = ""),
      yaxis = list(title = "", tickfont = list(size = y_tick_size), dtick = 1, automargin = TRUE),
      showlegend = FALSE,
      barmode = 'overlay',
      margin = list(l = margin_left)
    )
})

output$allAlbumsTable <- DT::renderDataTable({
  data <- allAlbumsCombined() %>%
    dplyr::filter(.data$Plays >= input$minPlays) %>%
    dplyr::filter(.data$avRat >= input$ratingRange[1], .data$avRat <= input$ratingRange[2])

  if (input$discogsFilter == "in") {
    data <- data %>% dplyr::filter(.data$inDiscogs)
  } else if (input$discogsFilter == "out") {
    data <- data %>% dplyr::filter(!.data$inDiscogs)
  }

  DT::datatable(
    data,
    filter = "top",
    options = list(
      pageLength = 30,
      scrollY = "68vh",
      scrollCollapse = TRUE
    )
  )
})

output$discogsDebugTable <- DT::renderDataTable({
  debug_data <- discogsDebugCombined()

  DT::datatable(
    debug_data,
    filter = "top",
    options = list(
      pageLength = 25,
      scrollX = TRUE,
      scrollY = "78vh",
      scrollCollapse = TRUE
    )
  )
})
```

# Discogs debug

## Controls {.sidebar}

```{r}
shiny::actionButton(
  inputId = "reloadDiscogsOverrides",
  label = "Reload overrides",
  icon = icon("refresh")
)

shiny::helpText("Reloads data/raw/discogs_overrides.tsv (or .csv fallback) without restarting the dashboard.")
```

## Row {data-height = "1200"}

```{r}
DT::DTOutput("discogsDebugTable", height = "80vh")
```
